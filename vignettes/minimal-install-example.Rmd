---
title: "raadtools/raadsync - minimal install"
author: "Michael Sumner and Ben Raymond"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{raadsync-minimal-install}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document is to illustrate the steps required to set up 'raadtools', a set of R tools to obtain and work with large environmental data sets. The data sets read by 'raadtools' are typically time series of remote-sensing data, but the 'raadsync' tools can be used to automatically download (and keep up-to-date) a wide variety of online data files. 


## Minimal install of raadtools sytem

To provide a working example we will download a relatively small set of daily sea ice concentation data. The steps are:  

* specify the configuration to download the sea ice for 2014 (southern)
* trigger raadsync to build the repository
* read in the data! 

Analogous facilities exist for SST, Aviso currents/ssh, ocean colour, NCEP winds, topography, and many more. Data sets can be added by inclusion in the local configuration.  

Note that the my_datadir value in step 1 will become populated with the source paths of the data collections. I.e. if "my_datdir <- 'C:/temp/dat'" then after running the synchronization it will contain a subfolder path will all the raw files: 

```
C:/temp/dat/data/data/ftp.aviso.altimetry.fr/global
C:/temp/dat/data/sidads.colorado.edu/
...
```

In particular the code below will build this specific collection. With these tools we decided to simply mirror the online address in our file system. 

```
C:/temp/dat/data/sidads.colorado.edu/pub/DATASETS/nsidc0051_gsfc_nasateam_seaice/final-gsfc/south/daily/2014
```

First install the packages 'raadtools' and 'raadsync' from github. 

```{r,eval=FALSE}
## install packages
devtools::install_github("AustralianAntarcticDivision/raadtools")
devtools::install_github("AustralianAntarcticDataCentre/raadsync")
```

Configure to obtain only sea ice data that matches files specific to 2014 (simply delete the "--accept" portion of the argument to get it all. 

### configure to download

The southern ocean NSDIC 25km ice for 2014 to a local repo. Note that this passive microwave remotely sensed data collection began in 1978 and is ongoing). 


```{r,eval=FALSE}
library(raadsync)
cfg <- read_repo_config(system.file("extdata", "raad_repo_config.json", package= "raadsync"))

ice_index <- 1

cfg$do_sync <- seq(nrow(cfg)) == ice_index

## limit our data to only the last year
cfg$method_flags[1] <- paste0(cfg$method_flags[1], "--accept=\"*nt_2014*\"")

## specify local repository location
## NOTE: this should point to your permanent data collection - at whatever path you need
my_datadir <- normalizePath("~/raaddata")
options(default.datadir = my_datadir)
cfg$local_file_root <- file.path(my_datadir, "data")
```

### trigger synchronization

Trigger raadsync to build the repository (this is set up in a 
```{r,eval=FALSE}
cron-task ultimately)
er <- sync_repo(cfg, create_root = TRUE)

## build the file cache 
## ( there are many, many files for some data, so needs a system shortcut )
my_datadir <- getOption("default.datadir")
my_admindir <- file.path(my_datadir, 'admin', 'filelist')
if (!file.exists(my_admindir)) dir.create(my_admindir, recursive = TRUE)
fs <- list.files(file.path(my_datadir, 'data'), all = TRUE, recursive = TRUE, full.names = TRUE, no.. = TRUE)
fs <- gsub(paste0(my_datadir, "/"), "", fs)
save(fs, file = file.path(my_datadir, 'admin', 'filelist', 'allfiles2.Rdata'))
writeLines(fs, file.path(my_datadir, 'admin', 'filelist', 'allfiles2.txt'))
```


### simple example to read the ice data

```{r,eval=FALSE}
library(raadtools)
ice <- readice(latest  = TRUE)

# class       : RasterLayer 
# dimensions  : 332, 316, 104912  (nrow, ncol, ncell)
# resolution  : 25000, 25000  (x, y)
# extent      : -3950000, 3950000, -3950000, 4350000  (xmin, xmax, ymin, ymax)
# coord. ref. : +proj=stere +lat_0=-90 +lat_ts=-70 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs 
# data source : in memory
# names       : nt_20141231_f17_v01_s.bin 
# values      : 0, 100  (min, max)
# time        : 2014-12-31

```